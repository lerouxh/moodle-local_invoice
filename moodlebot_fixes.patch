diff -ruN /mnt/data/invoice_orig/invoice/db/install.php /mnt/data/invoice_zip/invoice/db/install.php
--- /mnt/data/invoice_orig/invoice/db/install.php	2026-01-13 12:51:25.000000000 +0000
+++ /mnt/data/invoice_zip/invoice/db/install.php	2026-01-15 14:16:13.613555805 +0000
@@ -1,195 +1,198 @@
-<?php
-// This file is part of Moodle - http://moodle.org/
-//
-// Moodle is free software: you can redistribute it and/or modify
-// it under the terms of the GNU General Public License as published by
-// the Free Software Foundation, either version 3 of the License, or
-// (at your option) any later version.
-//
-// Moodle is distributed in the hope that it will be useful,
-// but WITHOUT ANY WARRANTY; without even the implied warranty of
-// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-// GNU General Public License for more details.
-//
-// You should have received a copy of the GNU General Public License
-// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.
-
-/**
- * Plugin version
- * @package    local_invoice
- * @copyright  2026 eLearn Solutions
- * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
- */
- 
-defined('MOODLE_INTERNAL') || die();
-
-/**
- * Plugin install hook.
- * - Ensures Custom menu items exist.
- * - If archive tables exist (created during a prior uninstall), restores invoice history.
- */
-function xmldb_local_invoice_install() {
-    global $DB;
-
-    $dbman = $DB->get_manager();
-
-    // ---------------------------------------------------------------------
-    // 0) OPTIONAL: Restore archived data (if uninstall archived it previously)
-    // ---------------------------------------------------------------------
-    if (!function_exists('local_invoice_restore_from_archive')) {
-        /**
-         * Restore archived data into live plugin tables if (and only if) live tables are empty.
-         * Leaves archives in place unless a full restore succeeds, in which case it drops them.
-         */
-        function local_invoice_restore_from_archive(moodle_database $DB): void {
-            $dbman = $DB->get_manager();
-
-            $archinvoice = new xmldb_table('local_invoice_archive');
-            $archuser    = new xmldb_table('local_invoice_user_archive');
-
-            // Nothing to do if archives do not exist.
-            if (!$dbman->table_exists($archinvoice) && !$dbman->table_exists($archuser)) {
-                return;
-            }
-
-            // Only restore into empty live tables (prevents overwriting / duplication).
-            $liveinvoicesempty = ($DB->count_records('local_invoice') === 0);
-            $liveuserempty     = ($DB->count_records('local_invoice_user') === 0);
-
-            // Helper: copy records from src to dst using only dst columns (excluding id).
-            $copy = function(string $srctable, string $dsttable) use ($DB): array {
-                $dstcolsinfo = $DB->get_columns($dsttable);
-                $dstcols = array_keys($dstcolsinfo);
-                $dstcols = array_flip($dstcols);
-
-                $src = $DB->get_records($srctable);
-                $total = count($src);
-                $inserted = 0;
-
-                foreach ($src as $r) {
-                    $o = new stdClass();
-                    foreach ($r as $k => $v) {
-                        if ($k === 'id') {
-                            continue;
-                        }
-                        if (isset($dstcols[$k])) {
-                            $o->$k = $v;
-                        }
-                    }
-                    // Skip empty objects (should not happen, but be safe).
-                    if (empty((array)$o)) {
-                        continue;
-                    }
-                    $DB->insert_record($dsttable, $o);
-                    $inserted++;
-                }
-
-                return [$total, $inserted];
-            };
-
-            try {
-                // Restore billing details first (local_invoice rows reference these fields in practice).
-                $userok = true;
-                if ($dbman->table_exists($archuser) && $liveuserempty) {
-                    [$tot, $ins] = $copy('local_invoice_user_archive', 'local_invoice_user');
-                    $userok = ($tot === $ins);
-                }
-
-                $invok = true;
-                if ($dbman->table_exists($archinvoice) && $liveinvoicesempty) {
-                    [$tot, $ins] = $copy('local_invoice_archive', 'local_invoice');
-                    $invok = ($tot === $ins);
-                }
-
-                // If we fully restored what we intended to restore, drop archives to avoid duplicates.
-                // (If a table was not restored because live table was not empty, we do not drop it.)
-                if ($liveuserempty && $dbman->table_exists($archuser) && $userok) {
-                    $dbman->drop_table($archuser);
-                }
-                if ($liveinvoicesempty && $dbman->table_exists($archinvoice) && $invok) {
-                    $dbman->drop_table($archinvoice);
-                }
-
-            } catch (Throwable $e) {
-                // Never fail installation because of restore problems.
-                // Leave archives in place for manual intervention.
-                if (function_exists('debugging')) {
-                    debugging('local_invoice: archive restore failed: ' . $e->getMessage(), DEBUG_DEVELOPER);
-                }
-            }
-        }
-    }
-
-    // Attempt restore if archives exist (safe no-op otherwise).
-    local_invoice_restore_from_archive($DB);
-
-    // --------------------------------------------------------
-    // 1) Existing Custom menu setup (kept as-is from your plugin)
-    // --------------------------------------------------------
-    $custommenu = (string) get_config('core', 'custommenuitems');
-
-    // Public menu.
-    $publicparent = 'My invoices';
-    $viewline     = '-View invoices|/local/invoice/invoice.php';
-    $billline     = '-Billing details|/local/invoice/billing.php';
-
-    // Admin-only menu (to be hidden for non-config users via JS).
-    $adminparent  = 'Invoices (admins)';
-    $adminline    = '-Settings|/admin/settings.php?section=local_invoice_settings';
-
-    if ($custommenu === '') {
-        $custommenu =
-            $publicparent . "\n" . $viewline . "\n" . $billline . "\n\n" .
-            $adminparent  . "\n" . $adminline;
-
-        set_config('custommenuitems', $custommenu);
-        return;
-    }
-
-    // -------------------------
-    // Ensure public block exists
-    // -------------------------
-    if (strpos($custommenu, $publicparent) === false) {
-        $custommenu .= "\n\n" . $publicparent . "\n" . $viewline . "\n" . $billline;
-    } else {
-        if (strpos($custommenu, $viewline) === false) {
-            $custommenu = preg_replace(
-                '/^' . preg_quote($publicparent, '/') . '$/m',
-                $publicparent . "\n" . $viewline,
-                $custommenu,
-                1
-            );
-        }
-
-        if (strpos($custommenu, $billline) === false) {
-            if (strpos($custommenu, $viewline) !== false) {
-                $custommenu = str_replace($viewline, $viewline . "\n" . $billline, $custommenu);
-            } else {
-                $custommenu = preg_replace(
-                    '/^' . preg_quote($publicparent, '/') . '$/m',
-                    $publicparent . "\n" . $billline,
-                    $custommenu,
-                    1
-                );
-            }
-        }
-    }
-
-    // -------------------------
-    // Ensure admin block exists
-    // -------------------------
-    if (strpos($custommenu, $adminparent) === false) {
-        $custommenu .= "\n\n" . $adminparent . "\n" . $adminline;
-    } else {
-        if (strpos($custommenu, $adminline) === false) {
-            $custommenu = preg_replace(
-                '/^' . preg_quote($adminparent, '/') . '$/m',
-                $adminparent . "\n" . $adminline,
-                $custommenu,
-                1
-            );
-        }
-    }
-
-    set_config('custommenuitems', $custommenu);
-}
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.
+
+/**
+ * Plugin version
+ * @package    local_invoice
+ * @copyright  2026 eLearn Solutions
+ * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+ 
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * Plugin install hook.
+ * - Ensures Custom menu items exist.
+ * - If archive tables exist (created during a prior uninstall), restores invoice history.
+ */
+function xmldb_local_invoice_install() {
+    global $DB;
+
+    $dbman = $DB->get_manager();
+
+    // ---------------------------------------------------------------------
+    // 0) OPTIONAL: Restore archived data (if uninstall archived it previously)
+    // ---------------------------------------------------------------------
+    if (!function_exists('local_invoice_restore_from_archive')) {
+        /**
+         * Restore archived data into live plugin tables if (and only if) live tables are empty.
+         * Leaves archives in place unless a full restore succeeds, in which case it drops them.
+	     *
+	     * @param moodle_database $DB The Moodle database handle.
+	     * @return void
+         */
+        function local_invoice_restore_from_archive(moodle_database $DB): void {
+            $dbman = $DB->get_manager();
+
+            $archinvoice = new xmldb_table('local_invoice_archive');
+            $archuser    = new xmldb_table('local_invoice_user_archive');
+
+            // Nothing to do if archives do not exist.
+            if (!$dbman->table_exists($archinvoice) && !$dbman->table_exists($archuser)) {
+                return;
+            }
+
+            // Only restore into empty live tables (prevents overwriting / duplication).
+            $liveinvoicesempty = ($DB->count_records('local_invoice') === 0);
+            $liveuserempty     = ($DB->count_records('local_invoice_user') === 0);
+
+            // Helper: copy records from src to dst using only dst columns (excluding id).
+            $copy = function(string $srctable, string $dsttable) use ($DB): array {
+                $dstcolsinfo = $DB->get_columns($dsttable);
+                $dstcols = array_keys($dstcolsinfo);
+                $dstcols = array_flip($dstcols);
+
+                $src = $DB->get_records($srctable);
+                $total = count($src);
+                $inserted = 0;
+
+                foreach ($src as $r) {
+                    $o = new stdClass();
+                    foreach ($r as $k => $v) {
+                        if ($k === 'id') {
+                            continue;
+                        }
+                        if (isset($dstcols[$k])) {
+                            $o->$k = $v;
+                        }
+                    }
+                    // Skip empty objects (should not happen, but be safe).
+                    if (empty((array)$o)) {
+                        continue;
+                    }
+                    $DB->insert_record($dsttable, $o);
+                    $inserted++;
+                }
+
+                return [$total, $inserted];
+            };
+
+            try {
+                // Restore billing details first (local_invoice rows reference these fields in practice).
+                $userok = true;
+                if ($dbman->table_exists($archuser) && $liveuserempty) {
+                    [$tot, $ins] = $copy('local_invoice_user_archive', 'local_invoice_user');
+                    $userok = ($tot === $ins);
+                }
+
+                $invok = true;
+                if ($dbman->table_exists($archinvoice) && $liveinvoicesempty) {
+                    [$tot, $ins] = $copy('local_invoice_archive', 'local_invoice');
+                    $invok = ($tot === $ins);
+                }
+
+                // If we fully restored what we intended to restore, drop archives to avoid duplicates.
+                // (If a table was not restored because live table was not empty, we do not drop it.)
+                if ($liveuserempty && $dbman->table_exists($archuser) && $userok) {
+                    $dbman->drop_table($archuser);
+                }
+                if ($liveinvoicesempty && $dbman->table_exists($archinvoice) && $invok) {
+                    $dbman->drop_table($archinvoice);
+                }
+
+            } catch (Throwable $e) {
+                // Never fail installation because of restore problems.
+                // Leave archives in place for manual intervention.
+                if (function_exists('debugging')) {
+                    debugging('local_invoice: archive restore failed: ' . $e->getMessage(), DEBUG_DEVELOPER);
+                }
+            }
+        }
+    }
+
+    // Attempt restore if archives exist (safe no-op otherwise).
+    local_invoice_restore_from_archive($DB);
+
+    // --------------------------------------------------------
+    // 1) Existing Custom menu setup (kept as-is from your plugin)
+    // --------------------------------------------------------
+    $custommenu = (string) get_config('core', 'custommenuitems');
+
+    // Public menu.
+    $publicparent = 'My invoices';
+    $viewline     = '-View invoices|/local/invoice/invoice.php';
+    $billline     = '-Billing details|/local/invoice/billing.php';
+
+    // Admin-only menu (to be hidden for non-config users via JS).
+    $adminparent  = 'Invoices (admins)';
+    $adminline    = '-Settings|/admin/settings.php?section=local_invoice_settings';
+
+    if ($custommenu === '') {
+        $custommenu =
+            $publicparent . "\n" . $viewline . "\n" . $billline . "\n\n" .
+            $adminparent  . "\n" . $adminline;
+
+        set_config('custommenuitems', $custommenu);
+        return;
+    }
+
+    // -------------------------
+    // Ensure public block exists
+    // -------------------------
+    if (strpos($custommenu, $publicparent) === false) {
+        $custommenu .= "\n\n" . $publicparent . "\n" . $viewline . "\n" . $billline;
+    } else {
+        if (strpos($custommenu, $viewline) === false) {
+            $custommenu = preg_replace(
+                '/^' . preg_quote($publicparent, '/') . '$/m',
+                $publicparent . "\n" . $viewline,
+                $custommenu,
+                1
+            );
+        }
+
+        if (strpos($custommenu, $billline) === false) {
+            if (strpos($custommenu, $viewline) !== false) {
+                $custommenu = str_replace($viewline, $viewline . "\n" . $billline, $custommenu);
+            } else {
+                $custommenu = preg_replace(
+                    '/^' . preg_quote($publicparent, '/') . '$/m',
+                    $publicparent . "\n" . $billline,
+                    $custommenu,
+                    1
+                );
+            }
+        }
+    }
+
+    // -------------------------
+    // Ensure admin block exists
+    // -------------------------
+    if (strpos($custommenu, $adminparent) === false) {
+        $custommenu .= "\n\n" . $adminparent . "\n" . $adminline;
+    } else {
+        if (strpos($custommenu, $adminline) === false) {
+            $custommenu = preg_replace(
+                '/^' . preg_quote($adminparent, '/') . '$/m',
+                $adminparent . "\n" . $adminline,
+                $custommenu,
+                1
+            );
+        }
+    }
+
+    set_config('custommenuitems', $custommenu);
+}
diff -ruN /mnt/data/invoice_orig/invoice/db/uninstall.php /mnt/data/invoice_zip/invoice/db/uninstall.php
--- /mnt/data/invoice_orig/invoice/db/uninstall.php	2026-01-13 12:51:25.000000000 +0000
+++ /mnt/data/invoice_zip/invoice/db/uninstall.php	2026-01-15 14:16:40.004857327 +0000
@@ -1,250 +1,257 @@
-<?php
-// This file is part of Moodle - http://moodle.org/
-//
-// Moodle is free software: you can redistribute it and/or modify
-// it under the terms of the GNU General Public License as published by
-// the Free Software Foundation, either version 3 of the License, or
-// (at your option) any later version.
-//
-// Moodle is distributed in the hope that it will be useful,
-// but WITHOUT ANY WARRANTY; without even the implied warranty of
-// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-// GNU General Public License for more details.
-//
-// You should have received a copy of the GNU General Public License
-// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.
-
-/**
- * Plugin version
- * @package    local_invoice
- * @copyright  2026 eLearn Solutions
- * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
- */
- 
-// local/invoice/db/uninstall.php
-
-defined('MOODLE_INTERNAL') || die();
-
-/**
- * Pre-uninstall hook.
- *
- * Strategy:
- * 1) Archive invoice history to tables NOT defined in install.xml (so Moodle won't drop them).
- * 2) Remove custom menu items added by this plugin.
- *
- * Notes:
- * - This prevents losing invoice numbering history on uninstall/reinstall.
- * - Your db/install.php (as previously shared) can restore from these archive tables on reinstall.
- */
-function xmldb_local_invoice_uninstall(): bool {
-    global $DB;
-
-    $dbman = $DB->get_manager();
-
-    // ---------------------------------------------------------------------
-    // 1) Archive data BEFORE Moodle drops plugin tables
-    // ---------------------------------------------------------------------
-    try {
-        local_invoice_archive_before_uninstall($DB, $dbman);
-    } catch (Throwable $e) {
-        // Do not hard-fail uninstall by default.
-        // If you prefer to BLOCK uninstall when archiving fails, replace this with:
-        // throw $e;
-        if (function_exists('debugging')) {
-            debugging('local_invoice: archive failed during uninstall: ' . $e->getMessage(), DEBUG_DEVELOPER);
-        }
-    }
-
-    // ---------------------------------------------------------------------
-    // 2) Remove custom menu items created by install.php
-    // ---------------------------------------------------------------------
-    $custommenu = (string) get_config('core', 'custommenuitems');
-    if ($custommenu === '') {
-        return true;
-    }
-
-    $publicparent = 'My invoices';
-    $viewline     = '-View invoices|/local/invoice/invoice.php';
-    $billline     = '-Billing details|/local/invoice/billing.php';
-
-    $adminparent  = 'Invoices (admins)';
-    $adminline    = '-Settings|/admin/settings.php?section=local_invoice_settings';
-
-    // Legacy line from earlier attempt (remove if present, exact match only).
-    $legacyline   = '-Settings (admins only)|/admin/settings.php?section=local_invoice_settings';
-
-    $normalized = preg_replace("/\r\n|\r/", "\n", $custommenu);
-    $lines = explode("\n", $normalized);
-
-    $removeChildren = [$viewline, $billline, $adminline, $legacyline];
-
-    $out = [];
-    $count = count($lines);
-
-    for ($i = 0; $i < $count; $i++) {
-        $line = $lines[$i];
-        $trim = trim($line);
-
-        // Remove our known child lines anywhere they appear (exact match only).
-        if (in_array($trim, $removeChildren, true)) {
-            continue;
-        }
-
-        // Handle parent blocks: drop parent if it ends up with no children.
-        if ($trim === $publicparent || $trim === $adminparent) {
-            $childrenkept = [];
-            $j = $i + 1;
-
-            while ($j < $count && preg_match('/^\s*-/', $lines[$j])) {
-                $childtrim = trim($lines[$j]);
-                if (!in_array($childtrim, $removeChildren, true)) {
-                    $childrenkept[] = $lines[$j];
-                }
-                $j++;
-            }
-
-            if (!empty($childrenkept)) {
-                $out[] = $line;
-                foreach ($childrenkept as $c) {
-                    $out[] = $c;
-                }
-            }
-
-            $i = $j - 1;
-            continue;
-        }
-
-        $out[] = $line;
-    }
-
-    $newcustommenu = rtrim(implode("\n", $out));
-    if ($newcustommenu !== rtrim($normalized)) {
-        set_config('custommenuitems', $newcustommenu);
-    }
-
-    return true;
-}
-
-/**
- * Create archive tables (if missing) and copy invoice history into them.
- *
- * Archive tables are intentionally NOT listed in install.xml so they survive uninstall.
- */
-function local_invoice_archive_before_uninstall(moodle_database $DB, database_manager $dbman): void {
-    // Only archive if the live tables exist.
-    $livetbl1 = new xmldb_table('local_invoice');
-    $livetbl2 = new xmldb_table('local_invoice_user');
-
-    if (!$dbman->table_exists($livetbl1) && !$dbman->table_exists($livetbl2)) {
-        return;
-    }
-
-    // Create archive tables if needed.
-    local_invoice_ensure_archive_tables($dbman);
-
-    // If archive tables already contain data, do not append again (avoids duplicates).
-    $already = false;
-    if ($dbman->table_exists(new xmldb_table('local_invoice_archive')) && $DB->count_records('local_invoice_archive') > 0) {
-        $already = true;
-    }
-    if ($dbman->table_exists(new xmldb_table('local_invoice_user_archive')) && $DB->count_records('local_invoice_user_archive') > 0) {
-        $already = true;
-    }
-    if ($already) {
-        return;
-    }
-
-    // Copy local_invoice_user -> local_invoice_user_archive
-    if ($dbman->table_exists($livetbl2)) {
-        $rs = $DB->get_recordset('local_invoice_user');
-        foreach ($rs as $r) {
-            unset($r->id);
-            $DB->insert_record('local_invoice_user_archive', $r);
-        }
-        $rs->close();
-    }
-
-    // Copy local_invoice -> local_invoice_archive
-    if ($dbman->table_exists($livetbl1)) {
-        $rs = $DB->get_recordset('local_invoice');
-        foreach ($rs as $r) {
-            unset($r->id);
-
-            // Forward-compatible: if your live table later adds invoiceprefix, it will be present and copied.
-            // If not present, the archive table default '' applies.
-
-            $DB->insert_record('local_invoice_archive', $r);
-        }
-        $rs->close();
-    }
-}
-
-/**
- * Ensure archive tables exist with a schema compatible with current plugin data.
- * Includes invoiceprefix for forward-compatibility with your planned upgrades.
- */
-function local_invoice_ensure_archive_tables(database_manager $dbman): void {
-    // ---------------------------------------------------------------------
-    // local_invoice_archive
-    // ---------------------------------------------------------------------
-    $t = new xmldb_table('local_invoice_archive');
-    if (!$dbman->table_exists($t)) {
-        $t->add_field('id', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, XMLDB_SEQUENCE, null);
-        $t->add_field('userid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
-        $t->add_field('enrolid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
-
-        // Forward-compatible: prefix used at time of issue (blank for FREE invoices).
-        $t->add_field('invoiceprefix', XMLDB_TYPE_CHAR, '20', null, null, null, null);
-
-        $t->add_field('invoicenumber', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
-        $t->add_field('coursename', XMLDB_TYPE_CHAR, '255', null, XMLDB_NOTNULL, null, null);
-        $t->add_field('cost', XMLDB_TYPE_CHAR, '20', null, XMLDB_NOTNULL, null, null);
-
-        $t->add_field('company', XMLDB_TYPE_CHAR, '255', null, null, null, null);
-        $t->add_field('vatnumber', XMLDB_TYPE_CHAR, '50', null, null, null, null);
-        $t->add_field('address', XMLDB_TYPE_CHAR, '255', null, null, null, null);
-        $t->add_field('city', XMLDB_TYPE_CHAR, '100', null, null, null, null);
-        $t->add_field('province', XMLDB_TYPE_CHAR, '100', null, null, null, null);
-        $t->add_field('postalcode', XMLDB_TYPE_CHAR, '20', null, null, null, null);
-
-        $t->add_field('paymentmethod', XMLDB_TYPE_CHAR, '20', null, XMLDB_NOTNULL, null, null);
-        $t->add_field('currencysymbol', XMLDB_TYPE_CHAR, '5', null, XMLDB_NOTNULL, null, null);
-        $t->add_field('timecreated', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
-
-        $t->add_key('primary', XMLDB_KEY_PRIMARY, ['id']);
-        // Keep the same uniqueness model as live data (one invoice per user+enrolid).
-        $t->add_key('uniqueuserenrol', XMLDB_KEY_UNIQUE, ['userid', 'enrolid']);
-
-        $dbman->create_table($t);
-    } else {
-        // If the archive table exists but lacks invoiceprefix (older archive), add it.
-        $field = new xmldb_field('invoiceprefix', XMLDB_TYPE_CHAR, '20', null, null, null, null);
-        if (!$dbman->field_exists($t, $field)) {
-            $dbman->add_field($t, $field);
-        }
-    }
-
-    // ---------------------------------------------------------------------
-    // local_invoice_user_archive
-    // ---------------------------------------------------------------------
-    $u = new xmldb_table('local_invoice_user_archive');
-    if (!$dbman->table_exists($u)) {
-        $u->add_field('id', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, XMLDB_SEQUENCE, null);
-        $u->add_field('userid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
-
-        $u->add_field('company', XMLDB_TYPE_CHAR, '255', null, null, null, null);
-        $u->add_field('vatnumber', XMLDB_TYPE_CHAR, '50', null, null, null, null);
-        $u->add_field('address', XMLDB_TYPE_CHAR, '255', null, null, null, null);
-        $u->add_field('city', XMLDB_TYPE_CHAR, '100', null, null, null, null);
-        $u->add_field('province', XMLDB_TYPE_CHAR, '100', null, null, null, null);
-        $u->add_field('postalcode', XMLDB_TYPE_CHAR, '20', null, null, null, null);
-
-        $u->add_field('timecreated', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
-        $u->add_field('timemodified', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
-
-        $u->add_key('primary', XMLDB_KEY_PRIMARY, ['id']);
-        $u->add_key('uniq_user', XMLDB_KEY_UNIQUE, ['userid']);
-
-        $dbman->create_table($u);
-    }
-}
+<?php
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.
+
+/**
+ * Plugin version
+ * @package    local_invoice
+ * @copyright  2026 eLearn Solutions
+ * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+ 
+// local/invoice/db/uninstall.php
+
+defined('MOODLE_INTERNAL') || die();
+
+/**
+ * Pre-uninstall hook.
+ *
+ * Strategy:
+ * 1) Archive invoice history to tables NOT defined in install.xml (so Moodle won't drop them).
+ * 2) Remove custom menu items added by this plugin.
+ *
+ * Notes:
+ * - This prevents losing invoice numbering history on uninstall/reinstall.
+ * - Your db/install.php (as previously shared) can restore from these archive tables on reinstall.
+ */
+function xmldb_local_invoice_uninstall(): bool {
+    global $DB;
+
+    $dbman = $DB->get_manager();
+
+    // ---------------------------------------------------------------------
+    // 1) Archive data BEFORE Moodle drops plugin tables
+    // ---------------------------------------------------------------------
+    try {
+        local_invoice_archive_before_uninstall($DB, $dbman);
+    } catch (Throwable $e) {
+        // Do not hard-fail uninstall by default.
+        // If you prefer to BLOCK uninstall when archiving fails, replace this with:
+        // throw $e;
+        if (function_exists('debugging')) {
+            debugging('local_invoice: archive failed during uninstall: ' . $e->getMessage(), DEBUG_DEVELOPER);
+        }
+    }
+
+    // ---------------------------------------------------------------------
+    // 2) Remove custom menu items created by install.php
+    // ---------------------------------------------------------------------
+    $custommenu = (string) get_config('core', 'custommenuitems');
+    if ($custommenu === '') {
+        return true;
+    }
+
+    $publicparent = 'My invoices';
+    $viewline     = '-View invoices|/local/invoice/invoice.php';
+    $billline     = '-Billing details|/local/invoice/billing.php';
+
+    $adminparent  = 'Invoices (admins)';
+    $adminline    = '-Settings|/admin/settings.php?section=local_invoice_settings';
+
+    // Legacy line from earlier attempt (remove if present, exact match only).
+    $legacyline   = '-Settings (admins only)|/admin/settings.php?section=local_invoice_settings';
+
+    $normalized = preg_replace("/\r\n|\r/", "\n", $custommenu);
+    $lines = explode("\n", $normalized);
+
+    $removeChildren = [$viewline, $billline, $adminline, $legacyline];
+
+    $out = [];
+    $count = count($lines);
+
+    for ($i = 0; $i < $count; $i++) {
+        $line = $lines[$i];
+        $trim = trim($line);
+
+        // Remove our known child lines anywhere they appear (exact match only).
+        if (in_array($trim, $removeChildren, true)) {
+            continue;
+        }
+
+        // Handle parent blocks: drop parent if it ends up with no children.
+        if ($trim === $publicparent || $trim === $adminparent) {
+            $childrenkept = [];
+            $j = $i + 1;
+
+            while ($j < $count && preg_match('/^\s*-/', $lines[$j])) {
+                $childtrim = trim($lines[$j]);
+                if (!in_array($childtrim, $removeChildren, true)) {
+                    $childrenkept[] = $lines[$j];
+                }
+                $j++;
+            }
+
+            if (!empty($childrenkept)) {
+                $out[] = $line;
+                foreach ($childrenkept as $c) {
+                    $out[] = $c;
+                }
+            }
+
+            $i = $j - 1;
+            continue;
+        }
+
+        $out[] = $line;
+    }
+
+    $newcustommenu = rtrim(implode("\n", $out));
+    if ($newcustommenu !== rtrim($normalized)) {
+        set_config('custommenuitems', $newcustommenu);
+    }
+
+    return true;
+}
+
+/**
+ * Create archive tables (if missing) and copy invoice history into them.
+ *
+ * Archive tables are intentionally NOT listed in install.xml so they survive uninstall.
+ *
+ * @param moodle_database $DB The Moodle database handle.
+ * @param database_manager $dbman The Moodle database manager.
+ * @return void
+ */
+function local_invoice_archive_before_uninstall(moodle_database $DB, database_manager $dbman): void {
+    // Only archive if the live tables exist.
+    $livetbl1 = new xmldb_table('local_invoice');
+    $livetbl2 = new xmldb_table('local_invoice_user');
+
+    if (!$dbman->table_exists($livetbl1) && !$dbman->table_exists($livetbl2)) {
+        return;
+    }
+
+    // Create archive tables if needed.
+    local_invoice_ensure_archive_tables($dbman);
+
+    // If archive tables already contain data, do not append again (avoids duplicates).
+    $already = false;
+    if ($dbman->table_exists(new xmldb_table('local_invoice_archive')) && $DB->count_records('local_invoice_archive') > 0) {
+        $already = true;
+    }
+    if ($dbman->table_exists(new xmldb_table('local_invoice_user_archive')) && $DB->count_records('local_invoice_user_archive') > 0) {
+        $already = true;
+    }
+    if ($already) {
+        return;
+    }
+
+    // Copy local_invoice_user -> local_invoice_user_archive
+    if ($dbman->table_exists($livetbl2)) {
+        $rs = $DB->get_recordset('local_invoice_user');
+        foreach ($rs as $r) {
+            unset($r->id);
+            $DB->insert_record('local_invoice_user_archive', $r);
+        }
+        $rs->close();
+    }
+
+    // Copy local_invoice -> local_invoice_archive
+    if ($dbman->table_exists($livetbl1)) {
+        $rs = $DB->get_recordset('local_invoice');
+        foreach ($rs as $r) {
+            unset($r->id);
+
+            // Forward-compatible: if your live table later adds invoiceprefix, it will be present and copied.
+            // If not present, the archive table default '' applies.
+
+            $DB->insert_record('local_invoice_archive', $r);
+        }
+        $rs->close();
+    }
+}
+
+/**
+ * Ensure archive tables exist with a schema compatible with current plugin data.
+ * Includes invoiceprefix for forward-compatibility with your planned upgrades.
+ *
+ * @param database_manager $dbman The Moodle database manager.
+ * @return void
+ */
+function local_invoice_ensure_archive_tables(database_manager $dbman): void {
+    // ---------------------------------------------------------------------
+    // local_invoice_archive
+    // ---------------------------------------------------------------------
+    $t = new xmldb_table('local_invoice_archive');
+    if (!$dbman->table_exists($t)) {
+        $t->add_field('id', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, XMLDB_SEQUENCE, null);
+        $t->add_field('userid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
+        $t->add_field('enrolid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
+
+        // Forward-compatible: prefix used at time of issue (blank for FREE invoices).
+        $t->add_field('invoiceprefix', XMLDB_TYPE_CHAR, '20', null, null, null, null);
+
+        $t->add_field('invoicenumber', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
+        $t->add_field('coursename', XMLDB_TYPE_CHAR, '255', null, XMLDB_NOTNULL, null, null);
+        $t->add_field('cost', XMLDB_TYPE_CHAR, '20', null, XMLDB_NOTNULL, null, null);
+
+        $t->add_field('company', XMLDB_TYPE_CHAR, '255', null, null, null, null);
+        $t->add_field('vatnumber', XMLDB_TYPE_CHAR, '50', null, null, null, null);
+        $t->add_field('address', XMLDB_TYPE_CHAR, '255', null, null, null, null);
+        $t->add_field('city', XMLDB_TYPE_CHAR, '100', null, null, null, null);
+        $t->add_field('province', XMLDB_TYPE_CHAR, '100', null, null, null, null);
+        $t->add_field('postalcode', XMLDB_TYPE_CHAR, '20', null, null, null, null);
+
+        $t->add_field('paymentmethod', XMLDB_TYPE_CHAR, '20', null, XMLDB_NOTNULL, null, null);
+        $t->add_field('currencysymbol', XMLDB_TYPE_CHAR, '5', null, XMLDB_NOTNULL, null, null);
+        $t->add_field('timecreated', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
+
+        $t->add_key('primary', XMLDB_KEY_PRIMARY, ['id']);
+        // Keep the same uniqueness model as live data (one invoice per user+enrolid).
+        $t->add_key('uniqueuserenrol', XMLDB_KEY_UNIQUE, ['userid', 'enrolid']);
+
+        $dbman->create_table($t);
+    } else {
+        // If the archive table exists but lacks invoiceprefix (older archive), add it.
+        $field = new xmldb_field('invoiceprefix', XMLDB_TYPE_CHAR, '20', null, null, null, null);
+        if (!$dbman->field_exists($t, $field)) {
+            $dbman->add_field($t, $field);
+        }
+    }
+
+    // ---------------------------------------------------------------------
+    // local_invoice_user_archive
+    // ---------------------------------------------------------------------
+    $u = new xmldb_table('local_invoice_user_archive');
+    if (!$dbman->table_exists($u)) {
+        $u->add_field('id', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, XMLDB_SEQUENCE, null);
+        $u->add_field('userid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
+
+        $u->add_field('company', XMLDB_TYPE_CHAR, '255', null, null, null, null);
+        $u->add_field('vatnumber', XMLDB_TYPE_CHAR, '50', null, null, null, null);
+        $u->add_field('address', XMLDB_TYPE_CHAR, '255', null, null, null, null);
+        $u->add_field('city', XMLDB_TYPE_CHAR, '100', null, null, null, null);
+        $u->add_field('province', XMLDB_TYPE_CHAR, '100', null, null, null, null);
+        $u->add_field('postalcode', XMLDB_TYPE_CHAR, '20', null, null, null, null);
+
+        $u->add_field('timecreated', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
+        $u->add_field('timemodified', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);
+
+        $u->add_key('primary', XMLDB_KEY_PRIMARY, ['id']);
+        $u->add_key('uniq_user', XMLDB_KEY_UNIQUE, ['userid']);
+
+        $dbman->create_table($u);
+    }
+}
diff -ruN /mnt/data/invoice_orig/invoice/generate_invoice.php /mnt/data/invoice_zip/invoice/generate_invoice.php
--- /mnt/data/invoice_orig/invoice/generate_invoice.php	2026-01-13 12:51:25.000000000 +0000
+++ /mnt/data/invoice_zip/invoice/generate_invoice.php	2026-01-15 14:17:09.803475897 +0000
@@ -47,6 +47,9 @@
      * Prefix used in the PDF filename.
      * IMPORTANT: Legacy behaviour â€” if stored prefix is empty, use "Invoice-" as TECHNICAL prefix
      * so previously-generated FREE invoices are still found and not duplicated.
+	     *
+	     * @param string|null $storedprefix The prefix stored on the invoice record (may be null).
+	     * @return string The safe prefix to use in filenames.
      */
     function local_invoice_prefix_for_filename(?string $storedprefix): string {
         $prefix = trim((string)$storedprefix);
diff -ruN /mnt/data/invoice_orig/invoice/invoice.php /mnt/data/invoice_zip/invoice/invoice.php
--- /mnt/data/invoice_orig/invoice/invoice.php	2026-01-13 12:51:25.000000000 +0000
+++ /mnt/data/invoice_zip/invoice/invoice.php	2026-01-15 14:17:55.265172283 +0000
@@ -35,6 +35,9 @@
     /**
      * Prefix stored in DB and printed on invoice.
      * Keep empty string if not configured (FREE invoices typically had no printed prefix).
+	     *
+	     * @param string $prefix The raw prefix configured in plugin settings.
+	     * @return string The safe prefix to store on invoice records (may be empty).
      */
     function local_invoice_prefix_for_storage(string $prefix): string {
         $prefix = trim($prefix);
@@ -48,6 +51,9 @@
     /**
      * Prefix used in the PDF filename.
      * Legacy behaviour: if stored prefix is empty, filename still uses "Invoice-" as technical prefix.
+	     *
+	     * @param string|null $storedprefix The prefix stored on the invoice record (may be null).
+	     * @return string The safe prefix to use in filenames.
      */
     function local_invoice_prefix_for_filename(?string $storedprefix): string {
         $prefix = trim((string)$storedprefix);
diff -ruN /mnt/data/invoice_orig/invoice/js/hide_admin_menu.js /mnt/data/invoice_zip/invoice/js/hide_admin_menu.js
--- /mnt/data/invoice_orig/invoice/js/hide_admin_menu.js	2026-01-13 12:51:25.000000000 +0000
+++ /mnt/data/invoice_zip/invoice/js/hide_admin_menu.js	2026-01-15 14:15:47.591571102 +0000
@@ -1,54 +1,66 @@
-// This file is part of Moodle - http://moodle.org/
-//
-// Moodle is free software: you can redistribute it and/or modify
-// it under the terms of the GNU General Public License as published by
-// the Free Software Foundation, either version 3 of the License, or
-// (at your option) any later version.
-//
-// Moodle is distributed in the hope that it will be useful,
-// but WITHOUT ANY WARRANTY; without even the implied warranty of
-// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-// GNU General Public License for more details.
-//
-// You should have received a copy of the GNU General Public License
-// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.
-
-/**
- * Plugin version
- * @package    local_invoice
- * @copyright  2026 eLearn Solutions
- * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
- */
- 
-// local/invoice/js/hide_admin_menu.js
-
-(function () {
-    function textIncludes(el, needle) {
-        if (!el) { return false; }
-        var t = (el.textContent || "").trim().toLowerCase();
-        return t.indexOf(needle.toLowerCase()) !== -1;
-    }
-
-    function hideInvoicesAdminsMenu() {
-        var needleHref = "/admin/settings.php?section=local_invoice_settings";
-        var links = document.querySelectorAll('a[href*="' + needleHref + '"]');
-
-        links.forEach(function (a) {
-            // Try to find the top-level menu <li> that contains the "Invoices (admins)" label.
-            var li = a.closest("li");
-            if (li && textIncludes(li, "Invoices (admins)")) {
-                li.style.display = "none";
-                return;
-            }
-
-            // Fallback: hide just the link (prevents hiding other menus like "My invoices").
-            a.style.display = "none";
-        });
-    }
-
-    if (document.readyState === "loading") {
-        document.addEventListener("DOMContentLoaded", hideInvoicesAdminsMenu);
-    } else {
-        hideInvoicesAdminsMenu();
-    }
-})();
+// This file is part of Moodle - http://moodle.org/
+//
+// Moodle is free software: you can redistribute it and/or modify
+// it under the terms of the GNU General Public License as published by
+// the Free Software Foundation, either version 3 of the License, or
+// (at your option) any later version.
+//
+// Moodle is distributed in the hope that it will be useful,
+// but WITHOUT ANY WARRANTY; without even the implied warranty of
+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+// GNU General Public License for more details.
+//
+// You should have received a copy of the GNU General Public License
+// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.
+
+/**
+ * Hide the admin-only invoice settings custom-menu item for non-admin users.
+ *
+ * @package    local_invoice
+ * @copyright  2026 eLearn Solutions
+ * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
+ */
+
+(function() {
+    /**
+     * Check whether an element's visible text contains a given string.
+     *
+     * @param {HTMLElement|null} el The element to inspect.
+     * @param {String} needle The text to look for.
+     * @returns {Boolean} True if found, false otherwise.
+     */
+    const textIncludes = (el, needle) => {
+        if (!el) {
+            return false;
+        }
+
+        const t = (el.textContent || '').trim().toLowerCase();
+        return t.includes(String(needle).toLowerCase());
+    };
+
+    /**
+     * Hide the "Invoices (admins)" block (or the settings link as a fallback).
+     */
+    const hideInvoicesAdminsMenu = () => {
+        const needleHref = '/admin/settings.php?section=local_invoice_settings';
+        const links = document.querySelectorAll(`a[href*="${needleHref}"]`);
+
+        links.forEach((a) => {
+            // Try to find the top-level menu <li> that contains the "Invoices (admins)" label.
+            const li = a.closest('li');
+            if (li && textIncludes(li, 'Invoices (admins)')) {
+                li.style.display = 'none';
+                return;
+            }
+
+            // Fallback: hide just the link (prevents hiding other menus like "My invoices").
+            a.style.display = 'none';
+        });
+    };
+
+    if (document.readyState === 'loading') {
+        document.addEventListener('DOMContentLoaded', hideInvoicesAdminsMenu);
+    } else {
+        hideInvoicesAdminsMenu();
+    }
+}());
diff -ruN /mnt/data/invoice_orig/invoice/tcpdf/include/tcpdf_static.php /mnt/data/invoice_zip/invoice/tcpdf/include/tcpdf_static.php
--- /mnt/data/invoice_orig/invoice/tcpdf/include/tcpdf_static.php	2026-01-13 12:51:25.000000000 +0000
+++ /mnt/data/invoice_zip/invoice/tcpdf/include/tcpdf_static.php	2026-01-15 14:18:14.575433402 +0000
@@ -2502,7 +2502,7 @@
 
 	/**
 	 * Get page dimensions from format name.
-	 * @param mixed $format The format name @see self::$page_format<ul>
+		 * @param mixed $format The format name (see self::$page_formats).
 	 * @return array containing page width and height in points
 	 * @since 5.0.010 (2010-05-17)
 	 * @public static
diff -ruN /mnt/data/invoice_orig/invoice/tcpdf/tcpdf.php /mnt/data/invoice_zip/invoice/tcpdf/tcpdf.php
--- /mnt/data/invoice_orig/invoice/tcpdf/tcpdf.php	2026-01-13 12:51:25.000000000 +0000
+++ /mnt/data/invoice_zip/invoice/tcpdf/tcpdf.php	2026-01-15 14:18:35.431948221 +0000
@@ -4941,6 +4941,9 @@
 
 	/**
 	 * Embed the attached files.
+		 *
+		 * @param array $opt Annotation options array (must include 'Subtype' and either 'FS' or embedded data).
+		 * @return void
 	 * @since 6.9.000 (2025-02-11)
 	 * @public
 	 */
@@ -4956,6 +4959,10 @@
 
 	/**
 	 * Embed the attached files.
+		 *
+		 * @param string $filename The filename to use inside the PDF.
+		 * @param string $content The file contents.
+		 * @return void
 	 * @since 6.9.000 (2025-02-11)
 	 * @public
 	 */
